# 5장 인덱싱

- 인덱싱의 정의
- 필드 선정 방법
- 인덱스 사용 평가와 적용
- 인덱스 생성 및 제거

## 5.1 인덱싱 소개

인덱스를 사용하지 않는 쿼리를 **컬렉션 스캔**이라 하고 전체 내용을 살펴봐야함을 의미한다.

explain 함수로 쿼리가 실행될 때 몽고디비가 무엇을 하는지 확인할 수 있다.

executionStats 모드로 살펴본 도큐먼트 개수, 실행 시간, 반환받은 결과 수 등을 확인할 수 있다.

쿼리 패턴에 인덱스를 사용하면 효율적으로 응답하게 할 수 있다.

### 5.1.1 인덱스 생성

createIndex 로 인덱스를 만들 수 있다. 

**단점**

1. 쓰기 연산은 더 오래 걸린다. 데이터가 변경될 때마다 인덱스를 갱신해야 하기 때문이다.

### 5.1.2 복합 인덱스 소개

상당수의 쿼리 패턴은 두 개 이상의 키를 기반으로 인덱스를 작성해야 한다. 

인덱스는 모든 값을 정렬된 순서로 보관한다.

정렬을 최적화하려면 인덱스를 만든다. 

쿼리에서 정렬 방향이 여러 개이거나 검색 조건에 여러 키가 있을 때 유용하다.

인덱스를 어느 방향으로도 쉽게 탐색한다.

**범위 검색에 정렬을 하면 인덱스를 타지 않는다. 정렬 작업을 지원하는 인덱스를 생성해야 한다.**

**복합 인덱스를 구성할 때에는 정렬 키를 첫 번째에 두는 것이 좋다.** 

### 5.1.3 몽고디비가 인덱스를 선택하는 방법

1. 인덱스 중에서 쿼리 후보로 몇 개를 식별 
2. 각 인덱스 후보에 총 3개의 쿼리 플랜 생성
3. 각각 다른 인덱스를 사용하는 3개의 병렬 스레드에서 쿼리 실행해서 어떤 스레드에서 가장 빨리 결과를 반환하는지 확인 
4. 빠른 쿼리 플랜이 승자가 되면 캐시에 저장해서 앞으로 동일한 모양의 쿼리에는 해당 인덱스가 사용된다.
5. 각 플랜은 일정 기간(시범 기간) 동안 서로 경쟁하여 승리 플랜을 산출하는데, 이기려면 결과를 먼저 반환하거나 시범 횟수를 정렬 순서로 가장 먼저 반환해야 한다.

### 5.1.4 복합 인덱스 사용

1. 인덱스의 선택성을 고려한다. 

디비가 특정 인덱스를 사용하도록 상제하는 두 가지 방법이 있는데 이는 운영 환경에 사용해서는 안된다.

- planCacheSetFilter함수를 인덱스 필터와 함께 쓰면 인덱스 필터에 지정된 인덱스만 고려하도록 제한할 수 있다.
- hist를 사용해서 사용할 인덱스를 지정할 수 있다.

보통 동등 필터를 사용할 필드가 다중값 필터를 사용할 필드보다 앞에 오도록 설계한다.

복합 인덱스의 문제로, 인메모리 정렬을 피하려면 반환하는 도큐먼트 개수보다 더 많은 키를 검사해야 한다. 즉, 복합 인덱스 키 사이에 정렬 필드를 포함해야 한다. → 첫 번째 키, 정렬할 키, 두 번째 키

따라서 ,

1. 동등 필터에 대한 키를 맨 앞에 표시해야 한다.
2. 정렬에 사용되는 키는 다중값 필드 앞에 표시해야 한다.
3. 다중값 필터에 대한 키는 마지막에 표시해야 한다.

#### 키 방향 선택하기 

단일 키로 정렬하면 인덱스를 쉽게 역순으로 읽을 수는 있지만, 방향이 다르게 다중 키로 정렬할 때에는 그 상황에 맞게 인덱스를 여러 개 생성해야 한다.

#### 커버드 쿼리 사용하기

인덱스가 쿼리가 요구하는 값을 모두 포함하면, 쿼리가 커버드된다고 한다.  실무에서는 도큐먼트로 되돌아가지 말고 커버드 쿼리를 사용해서 작업 셋을 훨씬 작게 만든다.

1. _id 필드를 반환받지 않도록 반환 받을 키를 지정한다.

커버드 쿼리에 explain을 실행하면 결과에 FETCH 단계의 하위가 아닌 IXSCAN단계가 있고, totalDocsExamined가 0이 된다.

#### 암시적 인덱스

복합 인덱스는 이중 임무를 수행할 수 있어서, age, username에 인덱스를 가지면 age 단일로 조회할 때 인덱스를 가질 때와 동일한 방법으로 정렬된다.

이는 인덱스의 접두사를 이용하는 쿼리에만 적용할 수 있다.
