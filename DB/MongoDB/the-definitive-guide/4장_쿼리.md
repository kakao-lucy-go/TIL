## 4.1 find

쿼리는 서브셋(빈 컬렉션 ~ 컬렉션 전체)을 반환한다. 첫 매개변수로 어떤 도큐먼트를 가져올 지 결정한다. 빈 쿼리 도큐먼트({})는 컬렉션 모두와 일치하고, 쿼리 도큐먼트가 없으면 빈 도큐먼트로 인식한다.

```json
db.c.find()
```

여러 키/값 쌍이 들어오는 경우 AND 조건이 된다.

```json
db.users.find({"username":"joe", "age":27})
```

### 4.1.1 반환받을 키 지정

특정 필드만 프로젝션할 수 있다. _id 는 항상 반환된다. 0으로 줘서 조회를 안할 수도 있다.

```json
db.users.find({}, {"username":1, "email":1, "_id":0})
```

### 4.1.2 제약 사항

쿼리 도큐먼트 값은 반드시 상수여야 하고 다른 키의 참조를 할 수 없다.

## 4.2 쿼리 조건

### 4.2.1 쿼리 조건절

- $lt: <
- $lte: ≤
- $gt: >
- $gte: ≥
- $ne: not

```json
db.users.find({"registered": {"$lt": new Date("01/01/2007")}
```

### 4.2.2 OR 쿼리

$in 은 하나의 키를 다양한 값과 비교. 서로 다른 데이터형도 쓸 수 있다.

$or: 여러 키를 주어진 값과 비교하는 쿼리

$nin: 조건과 일치하지 않는 도큐먼트 반환 

ex. 세 번호 중 적어도 하나와 일치하거나 winner가 true인 경우

```json
db.raffle.find({"$or": [{"ticket_no": {"$in": [725, 542, 390]}}, 
												{"winner": true}]})
```

AND 쿼리는 최소한의 인수로 최적의 결과를 추려내야 한다.

OR 쿼리는 첫 번째 인수가 일치하는 도큐먼트가 많을 수록 효율적이다.

$or에서 $in을 더 효율적으로 다룬다.

### 4.2.3 $not

$not은 메타 조건절이고 어떤 조건에도 사용할 수 있다.

## 4.3 형 특정 쿼리

### 4.3.1 null

null 인 값을 쿼리하면 해당 키를 갖지 않는 도큐먼트도 반환한다.

$existes조건절을 사용해서 Null 존재여부를 확인할 수 있다.

```json
db.c.find({"z": {"$eq": null, "$exists": true}})
```

### 4.3.2 정규 표현식

$regex는 패턴 일치 문자열을 위한 정규식을 제공한다. PCRE에서 쓸 수 있는 모든 문법은 몽고DB에서도 쓸 수 있다.

```json
db.users.find({"name": {"$regex": /joe/i}})
```

### 4.3.3 배열에 쿼리하기

배열 요소 쿼리는 스칼라 쿼리와 같은 방식으로 동작한다.

```json
db.food.insertOne({"fruit": ["apple", "banana", "peach"]})
db.food.find({"fruit":"banana"}) //조회 됨

//배열은 아래와 같이 취급
{"fruit": "apple", "fruit": "banana", "fruit": "peach"} 
```

#### 4.3.3.1 $all 연산자

2개 이상의 배열 요소가 일치하는 배열을 찾을 때 쓴다. 순서는 중요하지 않다.

전체와 일치하려면 $ 표현 없이 조회하면 된다.

fruit.2 와 같이 사용하면 인덱스에 접근할 수 있다.

#### 4.3.3.2 $size 연산자 

특정 크기의 배열을 쿼리한다. $gt같은 쿼리 조건절과 같이 사용할 수 없다.

#### 4.3.3.3 $slice 연산자 

두 번째 매개변수에 반환받을 특정 키를 지정할 때 배열 요소의 부분 집합을 반환받을 수 있다.

```json
db.blog.posts.findOne(criteria, {"comments": {"$slice":10}}) //먼저 달린 댓글 10개
db.blog.posts.findOne(criteria, {"comments": {"$slice":-10}}) //나중에 달린 댓글 10개
db.blog.posts.findOne(criteria, {"comments": {"$slice":[23, 10}}) //처음 23개는 건너뛰고 24~33번째 요소까지 반환
```

#### 4.3.3.4 일치하는 배열 요소의 반환 

두 번째 도큐먼트에 인덱스를 지정하면 일치하는 요소를 반환한다.

```json
db.blog.posts.fine({"comments.name":"bob"}, {"comments.$":1})
```

#### 배열 및 범위 쿼리의 상호작용 

범위 쿼리 시 배열 조회가 원하는 방식으로 동작하지 않을 수 있다.

```json
{"x": [5, 25]}
db.test.find({"x": {"$gt":10, "$lt":20}}) 에 출력됨
```

$elemMatch 연산자를 사용하면 위의 gt, lt가 배열에 And가 적용되어 결과에 나오지 않게 되지만, 빈 배열은 일치시키지 않는다. {”x”: 15}는 나오지 않는다. 따라서 한 필드에 배열값과 스칼라값을 함께 저장하려면 이유가 있어야 한다.

쿼리하는 필드에 인덱스가 있다면 min, max 함수로 인덱스 범위를 제한해 쿼리할 수 있다.

### 4.3.4 내장 도큐먼트에 쿼리하기

도큐먼트 전체를 대상으로 하는 방식과 도큐먼트 내 키와 값 쌍 각각을 대상으로 하는 방식으로 나뉜다. 

서브 도큐먼트 전체에 쿼리하려면 정확하게 일치해야 한다. 일부만 일치해도 조회되지 않고, 순서도 일치하지 않으면 조회되지 않는다.

특정 키로 쿼리하는 방법은 점 표기법을 사용한다. URL 을 키로 사용하는 경우에 문제를 일으키는데 .을 URL에 쓰이지 않는 문자로 바꾸는 방법으로 해결할 수 있다.

내장 도큐먼트는 스칼라로 조회할 수 없다. 전체가 일치해야하기 떄문이다. 점 표기법으로 특정 키를 조회하는 경우 AND가 아니기 때문에 각기 다른 조건에 일치되어 값이 반환된다. 조건을 정확하게 묶으려면 $elemMatch 를 사용한다.

### 4.4 $where 쿼리

$where로 자바스크립트를 쿼리의 일부분으로 실행하면 거의 모든 쿼리를 표현할 수 있지만 보안상의 이유로 사용을 제한해야 한다. 인덱스를 사용할수도 없고 일반 쿼리보다 훨씬 느리며 자바스크립트 객체로 반환된다. 

$expr 연산자는 자바스크립트를 실행하지 않고 집계 표현식을 사용할 수 있어서 where대신 사용을 권장한다.

## 4.5 커서

커서로 find의 결과를 반환한다. 결과 개수를 제한하거나 결과 몇 개를 건너 뛰거나 여러 키를 조합한 결과를 정렬하도록 조작할 수 있다. 

쿼리한 결과를 지역 변수에 할당(커서)한다. 결과를 한 번에 하나씩 볼 수 있는 장점이 있다.(cursor.next()) 

서버 왕복 횟수를 줄이기 위해 한번에 100개 또는 4MB의 결과를 가져오고 그 다음 요청 때 더 가져온다.

### 4.5.1 제한, 건너뛰기, 정렬

limit로 개수를 제한해서 가져올 수 있다.

skip 은 처음 몇 개를 건너뛰고 반환한다.

sort는 매개변수로 객체를 받아서 정렬한다.

세 개를 조합하면 페이지네이션할 때 편하다.

**비교순서**

1. 최솟값
2. null
3. 숫자
4. 문자열
5. 객체/도큐먼트
6. 배열
7. 이진 데이터
8. 객체 ID
9. 불리언
10. 날짜
11. 타임스탬프
12. 정규 표현식
13. 최댓값 

### 4.5.2 많은 수의 건너뛰기 피하기

수가 많을 때 skip의 수가 크면 느려진다.

#### 4.5.2.1 skip을 사용하지 않고 페이지 나누기 

sort를 먼저 해서 skip을 쓰지 않고 다음 페이지를 가져올 수도 있다.

#### 4.5.2.2 랜덤으로 도큐먼트 찾기 

random함수로 쿼리 조건에 사용할 수 있다.

### 4.5.3 종료되지 않는 커서

커서는 메모리와 리소스를 점유한다. 종료하는 조건은, 

1. 커서는 조건에 일치하는 결과를 모두 살펴본 후 스스로 정리한다.
2. 커서가 클라이언트측에서 유효 영역을 벗어나면 드라이버는 데이터베이스에 메시지를 보내 커서를 종료해도 된다고 노티한다.
3. 사용자가 아직 다 살펴보지않았더라도 10분동안 활동이 없으면 자동으로 죽는다.

하지만 커서를 오래 남겨두고 싶을 때 immortal 이라는 함수를 제공한다.
